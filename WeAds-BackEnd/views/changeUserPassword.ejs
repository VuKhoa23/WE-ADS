<%- include('./department/partials/header') %>
<div class="container-fluid d-flex justify-content-center">
  <div class="row justify-content-center col-12 col-sm-11 col-md-8 col-lg-6">
    <form id="change-password-form" class="license-form d-flex flex-column align-items-center">
      <div class="license-form-header">
        <h3 class="license-form-title">Đổi mật khẩu</h3>
      </div>
      <div class="change-password-section">
        <h3 class="change-password-label">Mật khẩu cũ:</h3>
        <input type="password" class="change-password-input old-password" name="oldPassword" required>
      </div>
      <div class="change-password-section">
        <h3 class="change-password-label">Mật khẩu mới:</h3>
        <input type="password" class="change-password-input new-password" name="newPassword" required>
      </div>
      <div class="change-password-section">
        <h3 class="change-password-label">Nhập lại mật khẩu mới:</h3>
        <input type="password" class="change-password-input retype-new-password" required>
      </div>
      <p class="change-password-error card-text text-danger"></p>
      <span class="seperate"></span>
      <span class="d-flex justify-content-center">
        <button id="change-password-submit" class="btn btn-success">Xác nhận</button>
      </span>
    </form>
  </div>
</div>


<script>
  function showSuccessModal() {
    Swal.fire({
        icon: 'success',
        title: 'Đổi mật khẩu thành công',
        showCancelButton: false,
        timer: null
    }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/weads/home';
        }
    });
  }
  $('#change-password-form').on('submit', async function(event) {
    event.preventDefault();
    $('#change-password-submit').prop("disabled", true);
    const oldPassword = $('.old-password').val();
    const newPassword = $('.new-password').val();
    const retype = $('.retype-new-password').val();

    if (newPassword.length < 6) {
      $('.change-password-error').html('<span>Mật khẩu mới phải có ít nhất 6 kí tự</span>')
      $('#change-password-submit').prop("disabled", false);
      return;
    }

    if (newPassword.includes(' ')) {
      $('.change-password-error').html('<span>Mật khẩu không được chứa khoảng trắng</span>')
      $('#change-password-submit').prop("disabled", false);
      return;
    }

    if (retype != newPassword) {
      $('.change-password-error').html('<span>Mật khẩu mới và mật khẩu nhập lại không trùng khớp</span>')
      $('#change-password-submit').prop("disabled", false);
      return;
    }

    const response = await fetch('/weads/user/change-password', {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        oldPassword,
        newPassword
      })
    })
    .then (function(result) {
      return result.json();
    })
    console.log(response);
    if (response.success)
      showSuccessModal();
    else {
      if (response.error == "Id not found") {
        window.location.replace("/weads/login");
      }
      let msg = response.error;
      $('.change-password-error').html('<span>'+ msg +'</span>')
      $('#change-password-submit').prop("disabled", false);
      return;
    }
  });
</script>
<%- include('./department/partials/footer') %>